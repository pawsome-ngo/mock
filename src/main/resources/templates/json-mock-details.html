<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Mock Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
            padding: 1rem;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-light bg-light shadow-sm">
    <div class="container-fluid justify-content-center">
        <a class="navbar-brand" href="/">
            <strong>Mock API Creator</strong>
        </a>
    </div>
</nav>
<div class="container mt-5">
    <h2 class="text-center">Mock Details for: <code th:text="${endpoint}"></code></h2>
    <div class="accordion mt-4" id="mocksAccordion">
        <div th:each="mock, iterStat : ${mockDetails}" class="accordion-item">
            <h2 class="accordion-header" th:id="'heading' + ${iterStat.index}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" th:data-bs-target="'#collapse' + ${iterStat.index}" aria-expanded="false" th:aria-controls="'collapse' + ${iterStat.index}">
                    <span th:text="${mock.name}"></span>
                </button>
            </h2>
            <div th:id="'collapse' + ${iterStat.index}" class="accordion-collapse collapse" th:aria-labelledby="'heading' + ${iterStat.index}" data-bs-parent="#mocksAccordion">
                <div class="accordion-body">
                    <pre><code th:text="${mock.content}"></code></pre>
                    <div class="text-end mt-2">
                        <button class="btn btn-danger btn-sm"
                                th:attr="data-bs-endpoint=${endpoint}, data-bs-index=${iterStat.index}"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteMockCaseModal">
                            Delete this Mock Case
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="text-center mt-4">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMockModal">
            Add New Mock Case
        </button>
        <a href="/" class="btn btn-secondary">Back to List</a>
    </div>
</div>

<!-- Add Mock Modal -->
<div class="modal fade" id="addMockModal" tabindex="-1" aria-labelledby="addMockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMockModalLabel">Add New Mock Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMockForm">
                    <input type="hidden" id="endpoint" th:value="${endpoint}">
                    <div class="mb-3">
                        <label for="mockName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="mockName" required>
                    </div>
                    <hr>
                    <h5>Request</h5>
                    <div class="mb-3">
                        <label for="mockMethod" class="form-label">Method</label>
                        <select class="form-select" id="mockMethod">
                            <option>GET</option>
                            <option>POST</option>
                            <option>PUT</option>
                            <option>DELETE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="mockHeaders" class="form-label">Headers (JSON)</label>
                        <textarea class="form-control" id="mockHeaders" rows="3">{}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="mockMatchKey" class="form-label">Match Key (leave blank for full body match)</label>
                        <input type="text" class="form-control" id="mockMatchKey">
                    </div>
                    <div class="mb-3">
                        <label for="mockRequestBody" class="form-label">Request Body (JSON)</label>
                        <textarea class="form-control" id="mockRequestBody" rows="5"></textarea>
                    </div>
                    <hr>
                    <h5>Response</h5>
                    <div class="mb-3">
                        <label for="mockResponseStatus" class="form-label">Status Code</label>
                        <input type="number" class="form-control" id="mockResponseStatus" value="200" required>
                    </div>
                    <div class="mb-3">
                        <label for="mockResponseBody" class="form-label">Response Body (JSON)</label>
                        <textarea class="form-control" id="mockResponseBody" rows="5"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewMock()">Save Mock</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Mock Case Modal -->
<div class="modal fade" id="deleteMockCaseModal" tabindex="-1" aria-labelledby="deleteMockCaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMockCaseModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this specific mock case?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteMockCase()">Delete Mock Case</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const mockDetails = /*[[${mockDetails}]]*/ [];
    /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    let endpointToDelete = '';
    let mockIndexToDelete = -1;

    const deleteMockCaseModal = document.getElementById('deleteMockCaseModal');
    deleteMockCaseModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        endpointToDelete = button.getAttribute('data-bs-endpoint');
        mockIndexToDelete = parseInt(button.getAttribute('data-bs-index'), 10);
    });

    function deleteMockCase() {
        fetch('/delete-mock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endpoint: endpointToDelete, index: mockIndexToDelete }),
        })
        .then(handleResponse)
        .then(() => {
            alert('Mock case deleted successfully!');
            window.location.reload();
        })
        .catch(handleError);
    }

    const addMockModal = document.getElementById('addMockModal');
    addMockModal.addEventListener('show.bs.modal', function (event) {
        if (mockDetails && mockDetails.length > 0) {
            const lastMockContent = mockDetails[mockDetails.length - 1].content;
            try {
                const lastMock = JSON.parse(lastMockContent);
                document.getElementById('mockName').value = lastMock.name + " (Copy)";
                document.getElementById('mockMethod').value = lastMock.request.method;
                document.getElementById('mockHeaders').value = JSON.stringify(lastMock.request.headers || {}, null, 2);
                document.getElementById('mockMatchKey').value = lastMock.request.matchKey || '';
                document.getElementById('mockRequestBody').value = lastMock.request.body ? JSON.stringify(lastMock.request.body, null, 2) : '';
                document.getElementById('mockResponseStatus').value = lastMock.response.status;
                document.getElementById('mockResponseBody').value = lastMock.response.body ? JSON.stringify(lastMock.response.body, null, 2) : '';
            } catch (e) {
                console.error("Failed to parse last mock, leaving form blank.", e);
                document.getElementById('addMockForm').reset();
                document.getElementById('mockHeaders').value = '{}';
            }
        } else {
            document.getElementById('addMockForm').reset();
            document.getElementById('mockHeaders').value = '{}';
        }
    });

    function saveNewMock() {
        const parseJsonOrNull = (elementId) => {
            const content = document.getElementById(elementId).value;
            if (!content.trim()) return null;
            try { return JSON.parse(content); } catch (e) {
                alert(`Invalid JSON in ${elementId}`);
                return 'INVALID_JSON';
            }
        };
        const headers = parseJsonOrNull('mockHeaders');
        const requestBody = parseJsonOrNull('mockRequestBody');
        const responseBody = parseJsonOrNull('mockResponseBody');

        if (headers === 'INVALID_JSON' || requestBody === 'INVALID_JSON' || responseBody === 'INVALID_JSON') return;

        const newMock = {
            name: document.getElementById('mockName').value,
            request: {
                method: document.getElementById('mockMethod').value,
                headers: headers || {},
                matchKey: document.getElementById('mockMatchKey').value || null,
                body: requestBody
            },
            response: {
                status: parseInt(document.getElementById('mockResponseStatus').value, 10),
                body: responseBody
            }
        };
        const payload = {
            endpoint: document.getElementById('endpoint').value,
            newMockJson: JSON.stringify(newMock)
        };
        fetch('/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        })
        .then(handleResponse)
        .then(() => {
            alert('Mock added successfully!');
            window.location.reload();
        })
        .catch(handleError);
    }

    function handleResponse(response) {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Unknown error occurred') });
        }
        return response.json();
    }

    function handleError(error) {
        console.error('Error:', error);
        alert('Operation failed: ' + error.message);
    }
</script>
</body>
</html>
