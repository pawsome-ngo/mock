<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Mock Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        pre {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
            padding: 1rem;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-light bg-light shadow-sm">
    <div class="container-fluid justify-content-center">
        <a class="navbar-brand" href="/">
            <strong>Mock API Creator</strong>
        </a>
    </div>
</nav>
<div class="container mt-5">
    <h2 class="text-center">Mock Details for: <code th:text="${endpoint}"></code></h2>
    <div class="accordion mt-4" id="mocksAccordion">
        <div th:each="mock, iterStat : ${mockDetails}" class="accordion-item">
            <h2 class="accordion-header" th:id="'heading' + ${iterStat.index}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" th:data-bs-target="'#collapse' + ${iterStat.index}" aria-expanded="false" th:aria-controls="'collapse' + ${iterStat.index}">
                    <span th:text="${mock.name}"></span>
                </button>
            </h2>
            <div th:id="'collapse' + ${iterStat.index}" class="accordion-collapse collapse" th:aria-labelledby="'heading' + ${iterStat.index}" data-bs-parent="#mocksAccordion">
                <div class="accordion-body">
                    <pre><code th:text="${mock.content}"></code></pre>
                    <div class="text-end mt-2">
                        <!-- NEW: Edit Button -->
                        <button class="btn btn-secondary btn-sm"
                                th:attr="data-bs-endpoint=${endpoint}, data-bs-index=${iterStat.index}, 'data-bs-content'=${mock.content}"
                                data-bs-toggle="modal"
                                data-bs-target="#editMockModal">
                            Edit
                        </button>
                        <button class="btn btn-danger btn-sm"
                                th:attr="data-bs-endpoint=${endpoint}, data-bs-index=${iterStat.index}"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteMockCaseModal">
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="text-center mt-4">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMockModal">
            Add New Mock Case
        </button>
        <a href="/" class="btn btn-secondary">Back to List</a>
    </div>
</div>

<!-- Add Mock Modal -->
<div class="modal fade" id="addMockModal" tabindex="-1" aria-labelledby="addMockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMockModalLabel">Add New Mock Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMockForm">
                    <input type="hidden" id="addEndpoint" th:value="${endpoint}">
                    <div class="mb-3">
                        <label for="addMockName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="addMockName" required>
                    </div>
                    <hr>
                    <h5>Request</h5>
                    <div class="mb-3">
                        <label for="addMockMethod" class="form-label">Method</label>
                        <select class="form-select" id="addMockMethod">
                            <option>GET</option> <option>POST</option> <option>PUT</option> <option>DELETE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addMockHeaders" class="form-label">Headers (JSON)</label>
                        <textarea class="form-control" id="addMockHeaders" rows="3">{}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="addMockMatchKey" class="form-label">Match Key (leave blank for full body match)</label>
                        <input type="text" class="form-control" id="addMockMatchKey">
                    </div>
                    <div class="mb-3">
                        <label for="addMockRequestBody" class="form-label">Request Body (JSON)</label>
                        <textarea class="form-control" id="addMockRequestBody" rows="5"></textarea>
                    </div>
                    <hr>
                    <h5>Response</h5>
                    <div class="mb-3">
                        <label for="addMockResponseStatus" class="form-label">Status Code</label>
                        <input type="number" class="form-control" id="addMockResponseStatus" value="200" required>
                    </div>
                    <div class="mb-3">
                        <label for="addMockResponseBody" class="form-label">Response Body (JSON)</label>
                        <textarea class="form-control" id="addMockResponseBody" rows="5"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewMock()">Save Mock</button>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Edit Mock Modal -->
<div class="modal fade" id="editMockModal" tabindex="-1" aria-labelledby="editMockModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMockModalLabel">Edit Mock Case</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMockForm">
                    <input type="hidden" id="editEndpoint">
                    <input type="hidden" id="editMockIndex">
                    <div class="mb-3">
                        <label for="editMockName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editMockName" required>
                    </div>
                    <hr>
                    <h5>Request</h5>
                    <div class="mb-3">
                        <label for="editMockMethod" class="form-label">Method</label>
                        <select class="form-select" id="editMockMethod">
                            <option>GET</option> <option>POST</option> <option>PUT</option> <option>DELETE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editMockHeaders" class="form-label">Headers (JSON)</label>
                        <textarea class="form-control" id="editMockHeaders" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editMockMatchKey" class="form-label">Match Key</label>
                        <input type="text" class="form-control" id="editMockMatchKey">
                    </div>
                    <div class="mb-3">
                        <label for="editMockRequestBody" class="form-label">Request Body (JSON)</label>
                        <textarea class="form-control" id="editMockRequestBody" rows="5"></textarea>
                    </div>
                    <hr>
                    <h5>Response</h5>
                    <div class="mb-3">
                        <label for="editMockResponseStatus" class="form-label">Status Code</label>
                        <input type="number" class="form-control" id="editMockResponseStatus" required>
                    </div>
                    <div class="mb-3">
                        <label for="editMockResponseBody" class="form-label">Response Body (JSON)</label>
                        <textarea class="form-control" id="editMockResponseBody" rows="5"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateMock()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Mock Case Modal -->
<div class="modal fade" id="deleteMockCaseModal" tabindex="-1" aria-labelledby="deleteMockCaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMockCaseModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this specific mock case?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteMockCase()">Delete Mock Case</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const mockDetails = /*[[${mockDetails}]]*/ [];
    /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script>
    let endpointToDelete = '';
    let mockIndexToDelete = -1;

    const deleteMockCaseModal = document.getElementById('deleteMockCaseModal');
    deleteMockCaseModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        endpointToDelete = button.getAttribute('data-bs-endpoint');
        mockIndexToDelete = parseInt(button.getAttribute('data-bs-index'), 10);
    });

    function deleteMockCase() {
        fetch('/delete-mock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ endpoint: endpointToDelete, index: mockIndexToDelete }),
        })
        .then(handleResponse)
        .then(() => {
            alert('Mock case deleted successfully!');
            window.location.reload();
        })
        .catch(handleError);
    }

    const addMockModal = document.getElementById('addMockModal');
    addMockModal.addEventListener('show.bs.modal', function (event) {
        if (mockDetails && mockDetails.length > 0) {
            const lastMockContent = mockDetails[mockDetails.length - 1].content;
            try {
                const lastMock = JSON.parse(lastMockContent);
                document.getElementById('addMockName').value = lastMock.name + " (Copy)";
                document.getElementById('addMockMethod').value = lastMock.request.method;
                document.getElementById('addMockHeaders').value = JSON.stringify(lastMock.request.headers || {}, null, 2);
                document.getElementById('addMockMatchKey').value = lastMock.request.matchKey || '';
                document.getElementById('addMockRequestBody').value = lastMock.request.body ? JSON.stringify(lastMock.request.body, null, 2) : '';
                document.getElementById('addMockResponseStatus').value = lastMock.response.status;
                document.getElementById('addMockResponseBody').value = lastMock.response.body ? JSON.stringify(lastMock.response.body, null, 2) : '';
            } catch (e) {
                console.error("Failed to parse last mock, leaving form blank.", e);
                document.getElementById('addMockForm').reset();
                document.getElementById('addMockHeaders').value = '{}';
            }
        } else {
            document.getElementById('addMockForm').reset();
            document.getElementById('addMockHeaders').value = '{}';
        }
    });

    // NEW: Event listener for the Edit Modal
    const editMockModal = document.getElementById('editMockModal');
    editMockModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const endpoint = button.getAttribute('data-bs-endpoint');
        const index = button.getAttribute('data-bs-index');
        const content = button.getAttribute('data-bs-content');

        try {
            const mock = JSON.parse(content);
            document.getElementById('editEndpoint').value = endpoint;
            document.getElementById('editMockIndex').value = index;
            document.getElementById('editMockName').value = mock.name;
            document.getElementById('editMockMethod').value = mock.request.method;
            document.getElementById('editMockHeaders').value = JSON.stringify(mock.request.headers || {}, null, 2);
            document.getElementById('editMockMatchKey').value = mock.request.matchKey || '';
            document.getElementById('editMockRequestBody').value = mock.request.body ? JSON.stringify(mock.request.body, null, 2) : '';
            document.getElementById('editMockResponseStatus').value = mock.response.status;
            document.getElementById('editMockResponseBody').value = mock.response.body ? JSON.stringify(mock.response.body, null, 2) : '';
        } catch (e) {
            console.error("Failed to parse mock content for editing.", e);
            alert("Error: Could not load mock data for editing.");
        }
    });

    function saveNewMock() {
        const newMock = buildMockObjectFromForm('add');
        if (!newMock) return;

        const payload = {
            endpoint: document.getElementById('addEndpoint').value,
            newMockJson: JSON.stringify(newMock)
        };
        fetch('/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        })
        .then(handleResponse)
        .then(() => {
            alert('Mock added successfully!');
            window.location.reload();
        })
        .catch(handleError);
    }

    // NEW: Function to save changes from the Edit Modal
    function updateMock() {
        const updatedMock = buildMockObjectFromForm('edit');
        if (!updatedMock) return;

        const payload = {
            endpoint: document.getElementById('editEndpoint').value,
            index: parseInt(document.getElementById('editMockIndex').value, 10),
            updatedMockJson: JSON.stringify(updatedMock)
        };
        fetch('/update-mock', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        })
        .then(handleResponse)
        .then(() => {
            alert('Mock updated successfully!');
            window.location.reload();
        })
        .catch(handleError);
    }

    function buildMockObjectFromForm(prefix) {
        const parseJsonOrNull = (elementId) => {
            const content = document.getElementById(elementId).value;
            if (!content.trim()) return null;
            try { return JSON.parse(content); } catch (e) {
                alert(`Invalid JSON in ${elementId}`);
                return 'INVALID_JSON';
            }
        };
        const headers = parseJsonOrNull(prefix + 'MockHeaders');
        const requestBody = parseJsonOrNull(prefix + 'MockRequestBody');
        const responseBody = parseJsonOrNull(prefix + 'MockResponseBody');

        if (headers === 'INVALID_JSON' || requestBody === 'INVALID_JSON' || responseBody === 'INVALID_JSON') return null;

        return {
            name: document.getElementById(prefix + 'MockName').value,
            request: {
                method: document.getElementById(prefix + 'MockMethod').value,
                headers: headers || {},
                matchKey: document.getElementById(prefix + 'MockMatchKey').value || null,
                body: requestBody
            },
            response: {
                status: parseInt(document.getElementById(prefix + 'MockResponseStatus').value, 10),
                body: responseBody
            }
        };
    }

    function handleResponse(response) {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Unknown error occurred') });
        }
        return response.json();
    }

    function handleError(error) {
        console.error('Error:', error);
        alert('Operation failed: ' + error.message);
    }
</script>
</body>
</html>
